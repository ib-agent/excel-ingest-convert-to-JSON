<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to JSON Converter</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            min-height: 100vh;
            color: #f8fafc;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: #f8fafc;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            color: #ffffff;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
            color: #e2e8f0;
        }

        .nav-back {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-back:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
        }

        .main-content {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .upload-section {
            padding: 3rem;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 3rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 2rem;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.3rem;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: #888;
            font-size: 1rem;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            display: none;
            margin-top: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            color: #555;
            font-size: 0.9rem;
        }

        .result-section {
            display: none;
            padding: 2rem;
            background: #f8f9fa;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .result-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .display-type-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .display-type-selector label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .display-type-selector select {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .display-type-selector select:hover {
            border-color: #667eea;
        }

        .display-type-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
        }

        .json-display {
            background: #1a202c;
            border-radius: 10px;
            padding: 1.5rem;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #e2e8f0;
            border: 1px solid #2d3748;
            position: relative;
        }

        .json-display::-webkit-scrollbar {
            width: 10px;
        }

        .json-display::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 5px;
        }

        .json-display::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 5px;
        }

        .json-display::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* JSON Syntax Highlighting */
        .json-key {
            color: #9f7aea;
            font-weight: 600;
        }

        .json-string {
            color: #68d391;
        }

        .json-number {
            color: #f6ad55;
        }

        .json-boolean {
            color: #fc8181;
        }

        .json-null {
            color: #a0aec0;
            font-style: italic;
        }

        .json-bracket {
            color: #e2e8f0;
            font-weight: 600;
        }

        .json-comma {
            color: #a0aec0;
        }

        .json-colon {
            color: #e2e8f0;
        }

        .error-section {
            display: none;
            background: #fed7d7;
            border: 1px solid #feb2b2;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1rem;
            color: #c53030;
        }

        .error-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        .file-info {
            background: #e8f4fd;
            border: 1px solid #bee3f8;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .file-info h4 {
            color: #2b6cb0;
            margin: 0;
        }

        .remove-file-btn {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .remove-file-btn:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        .current-file-display {
            background: white;
            border: 1px solid #bee3f8;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: #2b6cb0;
        }

        .current-file-display i {
            color: #28a745;
            font-size: 1.1rem;
        }

        .file-info p {
            color: #4a5568;
            margin: 0.25rem 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #155724;
            display: none;
        }

        .file-metadata {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: none;
        }

        .file-metadata h4 {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .metadata-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .metadata-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .metadata-value {
            color: #6c757d;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .table-display {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: none;
            overflow: hidden;
        }

        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
        }

        .table-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sheet-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .sheet-tab {
            padding: 0.75rem 1.5rem;
            background: #e9ecef;
            border: none;
            border-right: 1px solid #dee2e6;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
            text-align: center;
        }

        .sheet-tab:hover {
            background: #dee2e6;
        }

        .sheet-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .table-container {
            max-height: 400px;
            overflow: auto;
            background: white;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            border: 1px solid #dee2e6;
            padding: 0.5rem 0.75rem;
            vertical-align: top;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
        }

        .cell-formula {
            font-style: italic;
            color: #6c757d;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .cell-comment {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: #856404;
        }

        .cell-hyperlink {
            color: #007bff;
            text-decoration: underline;
        }

        .cell-hyperlink:hover {
            color: #0056b3;
        }

        .cell-currency {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-weight: 500;
        }

        .cell-negative {
            color: #dc3545;
            font-weight: 500;
        }

        .cell-negative.cell-currency {
            color: #dc3545;
        }

        .cell-with-formula {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #6c757d;
        }

        .cell-with-formula:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3748;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        .cell-with-formula:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #2d3748;
            z-index: 1000;
            pointer-events: none;
        }

        /* Cell Display Styles */
        .cell-display {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .cell-display::-webkit-scrollbar {
            width: 10px;
        }

        .cell-display::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 5px;
        }

        .cell-display::-webkit-scrollbar-thumb {
            background: #dee2e6;
            border-radius: 5px;
        }

        .cell-display::-webkit-scrollbar-thumb:hover {
            background: #adb5bd;
        }

        /* Card View Styles */
        .cell-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .cell-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .cell-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .cell-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .cell-coordinate {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .cell-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .cell-headers {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .header-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6c757d;
            min-width: 80px;
        }

        .header-values {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .header-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid #bbdefb;
        }

        .header-tag.column {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }

        .header-tag.row {
            background: #e8f5e8;
            color: #388e3c;
            border-color: #c8e6c9;
        }

        /* Table View Styles */
        .cell-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .cell-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .cell-table td {
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            vertical-align: top;
        }

        .cell-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .cell-table tr:hover {
            background: #e3f2fd;
        }

        /* Compact List Styles */
        .cell-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cell-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .cell-list-item:hover {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .cell-list-coordinate {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }

        .cell-list-value {
            font-weight: 600;
            color: #495057;
            min-width: 80px;
        }

        .cell-list-headers {
            display: flex;
            gap: 1rem;
            flex: 1;
        }

        .cell-list-header-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cell-list-header-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6c757d;
            min-width: 60px;
        }

        .cell-list-header-tags {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .cell-list-header-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.2rem 0.4rem;
            border-radius: 8px;
            font-size: 0.75rem;
            border: 1px solid #bbdefb;
        }

        .cell-list-header-tag.column {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }

        .cell-list-header-tag.row {
            background: #e8f5e8;
            color: #388e3c;
            border-color: #c8e6c9;
        }

        /* Table Summary Styles */
        .table-summary-display {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .summary-sheet {
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .summary-sheet:last-child {
            margin-bottom: 0;
        }

        .summary-sheet-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-sheet-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .summary-sheet-stats {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .summary-tables {
            background: #f8f9fa;
        }

        .summary-table {
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
            transition: background-color 0.3s ease;
        }

        .summary-table:last-child {
            border-bottom: none;
        }

        .summary-table:hover {
            background: #e3f2fd;
        }

        .summary-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .summary-table-title {
            font-size: 1rem;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }

        .summary-table-size {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .summary-table-coordinates {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .summary-coordinate-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-coordinate-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-coordinate-value {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .summary-coordinate-range {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .summary-no-tables {
            padding: 2rem;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .summary-table-title.detected-title {
            color: #28a745;
        }

        .summary-table-title.detected-title .fa-tag {
            color: #ffc107;
            margin-right: 0.25rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .upload-section {
                padding: 2rem 1rem;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .result-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .download-btn {
                text-align: center;
                justify-content: center;
            }

            .nav-back {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 1rem;
                display: inline-block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="nav-back">
            <i class="fas fa-arrow-left"></i> Back to Main Menu
        </a>

        <div class="header">
            <h1><i class="fas fa-file-excel"></i> Excel to JSON Converter</h1>
            <p>Upload your Excel files and convert them to comprehensive JSON format</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Drag & Drop your Excel file here</div>
                    <div class="upload-subtext">or click to browse files</div>
                    <div class="upload-subtext">Supports: .xlsx, .xlsm, .xltx, .xltm</div>
                </div>

                <div class="format-info" style="margin-bottom: 1rem; padding: 0.75rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 0.25rem;">
                        <i class="fas fa-compress-alt"></i> Optimized Processing
                    </div>
                    <div style="font-size: 0.9rem; color: #424242;">
                        Using compact format with Run-Length Encoding for optimal performance and memory efficiency
                    </div>
                </div>

                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xlsm,.xltx,.xltm">
                <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> Choose File
                </button>

                <div class="progress-section" id="progressSection">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing...</div>
                </div>

                <div class="error-section" id="errorSection">
                    <i class="fas fa-exclamation-triangle error-icon"></i>
                    <span id="errorMessage"></span>
                </div>

                <div class="success-message" id="successMessage">
                    <i class="fas fa-check-circle"></i>
                    File processed successfully!
                </div>
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-header">
                    <h4><i class="fas fa-info-circle"></i> File Information</h4>
                    <button class="remove-file-btn" id="removeFileBtn" onclick="removeFile()" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="current-file-display" id="currentFileDisplay">
                    <i class="fas fa-file-excel"></i>
                    <span id="fullFileName"></span>
                </div>
                <p><strong>Size:</strong> <span id="fileSize"></span></p>
                <p><strong>Sheets:</strong> <span id="sheetCount"></span></p>
            </div>

            <div class="table-display" id="tableDisplay">
                <div class="table-header">
                    <h4><i class="fas fa-table"></i> Data Preview</h4>
                </div>
                <div class="sheet-tabs" id="sheetTabs">
                    <!-- Sheet tabs will be generated here -->
                </div>
                <div class="table-container" id="tableContainer">
                    <!-- Table will be generated here -->
                </div>
            </div>

            <div class="file-metadata" id="fileMetadata">
                <h4><i class="fas fa-info-circle"></i> File Metadata</h4>
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <span class="metadata-label">File Name:</span>
                        <span class="metadata-value" id="metaFileName"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">File Size:</span>
                        <span class="metadata-value" id="metaFileSize"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Last Modified:</span>
                        <span class="metadata-value" id="metaLastModified"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">File Type:</span>
                        <span class="metadata-value" id="metaFileType"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Number of Sheets:</span>
                        <span class="metadata-value" id="metaSheetCount"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Processing Time:</span>
                        <span class="metadata-value" id="metaProcessingTime"></span>
                    </div>
                </div>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-header">
                    <div class="result-title">
                        <i class="fas fa-code"></i> Original Excel JSON Output
                    </div>
                    <div class="result-controls">
                        <div class="display-type-selector">
                            <label for="displayType">Display Type:</label>
                            <select id="displayType" onchange="changeDisplayType()">
                                <option value="formatted">Formatted</option>
                                <option value="compact">Compact</option>
                                <option value="raw">Raw</option>
                            </select>
                        </div>
                        <button class="download-btn" id="downloadBtn" onclick="downloadJSON()">
                            <i class="fas fa-download"></i> Download JSON
                        </button>
                    </div>
                </div>
                <div class="json-display" id="jsonDisplay"></div>
            </div>

            <div class="result-section" id="tableSummarySection">
                <div class="result-header">
                    <div class="result-title">
                        <i class="fas fa-chart-bar"></i> Table Summary
                    </div>
                </div>
                <div class="table-summary-display" id="tableSummaryDisplay"></div>
            </div>

            <div class="result-section" id="tableResultSection">
                <div class="result-header">
                    <div class="result-title">
                        <i class="fas fa-table"></i> Table-Oriented JSON Output
                    </div>
                    <div class="result-controls">
                        <div class="display-type-selector">
                            <label for="tableDisplayType">Display Type:</label>
                            <select id="tableDisplayType" onchange="changeTableDisplayType()">
                                <option value="formatted">Formatted</option>
                                <option value="compact">Compact</option>
                                <option value="raw">Raw</option>
                            </select>
                        </div>
                        <button class="download-btn" id="downloadTableBtn" onclick="downloadTableJSON()">
                            <i class="fas fa-download"></i> Download Table JSON
                        </button>
                    </div>
                </div>
                <div class="json-display" id="tableJsonDisplay"></div>
            </div>

            <div class="result-section" id="cellDisplaySection">
                <div class="result-header">
                    <div class="result-title">
                        <i class="fas fa-th"></i> Cell Data with Headers
                    </div>
                    <div class="result-controls">
                        <div class="display-type-selector">
                            <label for="cellDisplayType">View Mode:</label>
                            <select id="cellDisplayType" onchange="changeCellDisplayType()">
                                <option value="cards">Card View</option>
                                <option value="table">Table View</option>
                                <option value="compact">Compact List</option>
                            </select>
                        </div>
                        <button class="download-btn" id="downloadCellDataBtn" onclick="downloadCellData()">
                            <i class="fas fa-download"></i> Download Cell Data
                        </button>
                    </div>
                </div>
                <div class="cell-display" id="cellDisplay"></div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let jsonData = null;
        let tableData = null;
        let processingStartTime = null;
        let currentDisplayType = 'formatted';
        let currentTableDisplayType = 'formatted';
        let currentCellDisplayType = 'cards';
        let currentSheetIndex = 0;
        let currentCellSheetIndex = 0;
        let convertedDisplayData = null; // Store converted data globally

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // DOM elements
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const progressSection = document.getElementById('progressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const fileInfo = document.getElementById('fileInfo');
            const fullFileName = document.getElementById('fullFileName');
            const fileSize = document.getElementById('fileSize');
            const sheetCount = document.getElementById('sheetCount');
            const tableDisplay = document.getElementById('tableDisplay');
            const sheetTabs = document.getElementById('sheetTabs');
            const tableContainer = document.getElementById('tableContainer');
            const fileMetadata = document.getElementById('fileMetadata');
            const metaFileName = document.getElementById('metaFileName');
            const metaFileSize = document.getElementById('metaFileSize');
            const metaLastModified = document.getElementById('metaLastModified');
            const metaFileType = document.getElementById('metaFileType');
            const metaSheetCount = document.getElementById('metaSheetCount');
            const metaProcessingTime = document.getElementById('metaProcessingTime');
            const resultSection = document.getElementById('resultSection');
            const jsonDisplay = document.getElementById('jsonDisplay');
            const downloadBtn = document.getElementById('downloadBtn');
            const displayType = document.getElementById('displayType');
            const tableSummarySection = document.getElementById('tableSummarySection');
            const tableResultSection = document.getElementById('tableResultSection');
            const tableJsonDisplay = document.getElementById('tableJsonDisplay');
            const downloadTableBtn = document.getElementById('downloadTableBtn');
            const tableDisplayType = document.getElementById('tableDisplayType');
            const cellDisplaySection = document.getElementById('cellDisplaySection');
            const cellDisplay = document.getElementById('cellDisplay');
            const downloadCellDataBtn = document.getElementById('downloadCellDataBtn');
            const cellDisplayType = document.getElementById('cellDisplayType');

            // Check if all required elements exist
            if (!uploadArea || !fileInput || !uploadBtn) {
                return;
            }

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            function handleFile(file) {
                // Validate file type
                const allowedTypes = ['.xlsx', '.xlsm', '.xltx', '.xltm'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(fileExtension)) {
                    showError(`Unsupported file format. Please upload a file with one of these extensions: ${allowedTypes.join(', ')}`);
                    return;
                }

                // Validate file size (50MB limit)
                if (file.size > 50 * 1024 * 1024) {
                    showError('File size too large. Please upload a file smaller than 50MB.');
                    return;
                }

                currentFile = file;
                uploadFile(file);
            }

            function uploadFile(file) {
                const formData = new FormData();
                formData.append('file', file);

                // Start timing
                processingStartTime = Date.now();

                // Show progress
                showProgress();
                hideError();
                hideSuccess();

                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 90) progress = 90;
                    updateProgress(progress);
                }, 200);

                console.log('Starting upload for file:', file.name);
                console.log('File size:', file.size);
                
                // Always use compact format (RLE-enabled)
                const selectedFormat = 'compact';
                console.log('Using compact format with RLE:', selectedFormat);
                
                fetch(`/api/upload/?format=${selectedFormat}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log('Fetch response received');
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    clearInterval(progressInterval);
                    updateProgress(100);
                    
                    console.log('Server response:', data);
                    
                    if (data.success) {
                        console.log('Large file check:', data.large_file);
                        console.log('Format used:', data.format);
                        console.log('Compression stats:', data.compression_stats);
                        if (data.large_file) {
                            console.log('Handling as large file');
                            // Handle large file response
                            showLargeFileWarning(data);
                            showLargeFileInfo(file, data);
                            showLargeFileSummary(data.summary);
                            showDownloadLinks(data.download_urls, data.file_info);
                            showSuccess();
                        } else {
                            console.log('Handling as normal file');
                            // Handle normal file response
                            jsonData = data.data;
                            tableData = data.table_data;
                            showSuccess();
                            showFileInfo(file, data.data);
                            showTableDisplay(data.data);
                            showMetadata(file, data.data);
                            showResult(data.data);
                            showTableResult(data);
                            showCellDisplay(data.table_data);
                        }
                    } else {
                        showError(data.error || 'An error occurred while processing the file.');
                    }
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    showError('Network error. Please check your connection and try again.');
                    console.error('Error:', error);
                })
                .finally(() => {
                    hideProgress();
                });
            }

            function showProgress() {
                progressSection.style.display = 'block';
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<div class="loading-spinner"></div>Processing...';
            }

            function hideProgress() {
                progressSection.style.display = 'none';
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Choose File';
            }

            function updateProgress(percent) {
                progressFill.style.width = percent + '%';
                progressText.textContent = `Processing... ${Math.round(percent)}%`;
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorSection.style.display = 'block';
            }

            function hideError() {
                errorSection.style.display = 'none';
            }

            function showSuccess() {
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            }

            function hideSuccess() {
                successMessage.style.display = 'none';
            }

            function showFileInfo(file, data) {
                fullFileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                
                // Defensive check for data structure
                if (data && data.workbook && data.workbook.sheets) {
                    sheetCount.textContent = data.workbook.sheets.length;
                    fileInfo.style.display = 'block';
                } else {
                    console.error('Invalid data structure for showFileInfo:', data);
                    showError('Invalid data structure received from server.');
                }
            }

            function showMetadata(file, data) {
                const processingTime = Date.now() - processingStartTime;
                
                metaFileName.textContent = file.name;
                metaFileSize.textContent = formatFileSize(file.size);
                metaLastModified.textContent = new Date(file.lastModified).toLocaleString();
                metaFileType.textContent = file.type || 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                metaSheetCount.textContent = data.workbook.sheets.length;
                metaProcessingTime.textContent = `${processingTime}ms`;
                
                fileMetadata.style.display = 'block';
            }

            function showTableDisplay(data) {
                // Convert compact format to verbose format for display
                convertedDisplayData = convertToDisplayFormat(data);
                createSheetTabs(convertedDisplayData.workbook.sheets);
                showSheet(convertedDisplayData.workbook.sheets[currentSheetIndex]);
                tableDisplay.style.display = 'block';
            }
            
            function convertToDisplayFormat(data) {
                // Check if data.workbook has sheets with rows (compact format)
                if (data.workbook && data.workbook.sheets && data.workbook.sheets[0]) {
                    const firstSheet = data.workbook.sheets[0];
                    
                    // If it has cells, it's already verbose format
                    if (firstSheet.cells) {
                        return data;
                    }
                    
                    // If it has rows, it's compact format - convert it
                    if (firstSheet.rows) {
                        return convertCompactToVerbose(data);
                    }
                }
                
                // Check if data is in 'data' field (compact format)
                if (data.data && data.data.workbook && data.data.workbook.sheets) {
                    return convertCompactToVerbose(data.data);
                }
                
                // Convert compact format to display format
                if (data.table_data && data.table_data.workbook && data.table_data.workbook.sheets) {
                    return convertCompactToVerbose(data.table_data);
                }
                
                // Fallback: return original data
                return data;
            }
            
            function convertCompactToVerbose(compactData) {
                const convertedData = {
                    workbook: {
                        meta: compactData.workbook.meta || {},
                        styles: compactData.workbook.styles || {},
                        sheets: []
                    }
                };
                
                // Convert each sheet from compact to verbose format
                for (let i = 0; i < compactData.workbook.sheets.length; i++) {
                    const sheet = compactData.workbook.sheets[i];
                    const convertedSheet = {
                        name: sheet.name,
                        dimensions: sheet.dimensions,
                        frozen: sheet.frozen,
                        cells: {},
                        tables: sheet.tables || []
                    };
                    
                    // Convert rows array to cells object
                    if (sheet.rows) {
                        for (const row of sheet.rows) {
                            const rowNum = row.r;
                            if (row.cells) {
                                for (const cell of row.cells) {
                                    const colNum = cell[0];
                                    const value = cell[1];
                                    const style = cell[2];
                                    const formula = cell[3];
                                    
                                    const cellRef = getCellRef(rowNum, colNum);
                                    convertedSheet.cells[cellRef] = {
                                        value: value,
                                        style: style,
                                        formula: formula
                                    };
                                }
                            }
                        }
                    }
                    
                    convertedData.workbook.sheets.push(convertedSheet);
                }
                
                return convertedData;
            }
            
            function getCellRef(row, col) {
                // Convert row/col numbers to Excel cell reference (e.g., 1,1 -> A1)
                let colStr = '';
                let tempCol = col;
                while (tempCol > 0) {
                    tempCol--;
                    colStr = String.fromCharCode(65 + (tempCol % 26)) + colStr;
                    tempCol = Math.floor(tempCol / 26);
                }
                return colStr + row;
            }

            function showResult(data) {
                updateJSONDisplay(data);
                resultSection.style.display = 'block';
                
                // Update download button with file size and make visible
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    // Use server-provided size metadata for accuracy
                    let sizeKB;
                    if (data.size_metadata && data.size_metadata.full_json_size_kb) {
                        sizeKB = data.size_metadata.full_json_size_kb.toFixed(1);
                    } else {
                        // Fallback to calculating full data size
                        const jsonSize = JSON.stringify(data.data || data).length;
                        sizeKB = (jsonSize / 1024).toFixed(1);
                    }
                    downloadBtn.innerHTML = `<i class="fas fa-download"></i> Download JSON (${sizeKB} KB)`;
                    downloadBtn.style.display = 'inline-flex';
                }
                
                // Scroll to result
                resultSection.scrollIntoView({ behavior: 'smooth' });
            }

            function showTableResult(data) {
                updateTableJSONDisplay(data);
                tableResultSection.style.display = 'block';
                
                // Show table summary
                showTableSummary(data);
                
                // Ensure download button is visible
                const downloadTableBtn = document.getElementById('downloadTableBtn');
                if (downloadTableBtn) {
                    // Calculate table data size using server metadata
                    let tableSizeKB;
                    
                    // Debug: Log the full response structure
                    console.log('DEBUG: showTableResult received keys:', Object.keys(data));
                    
                    if (data.size_metadata && data.size_metadata.table_data_size_kb) {
                        tableSizeKB = data.size_metadata.table_data_size_kb.toFixed(1);
                        console.log('DEBUG: Using server metadata for table size:', tableSizeKB, 'KB');
                    } else if (data.table_data) {
                        // Fallback to calculating table data size only if table_data exists
                        const tableSize = JSON.stringify(data.table_data).length;
                        tableSizeKB = (tableSize / 1024).toFixed(1);
                        console.log('DEBUG: Calculated table size from table_data:', tableSizeKB, 'KB');
                    } else {
                        // Check if this is the verbose format issue where table_data is missing
                        console.log('DEBUG: No table_data or size_metadata found');
                        console.log('DEBUG: Full response structure:', JSON.stringify(data, null, 2).substring(0, 500) + '...');
                        
                        // For verbose format, try to estimate from data size
                        if (data.data && data.data.workbook) {
                            // Estimate based on workbook size - rough approximation
                            const workbookSize = JSON.stringify(data.data.workbook).length;
                            tableSizeKB = (workbookSize / 1024 * 0.6).toFixed(1); // Table data is typically ~60% of workbook
                            console.log('DEBUG: Estimated table size from workbook size:', tableSizeKB, 'KB');
                        } else {
                            tableSizeKB = '0.0';
                            console.log('DEBUG: No data available for size calculation');
                        }
                    }
                    downloadTableBtn.innerHTML = `<i class="fas fa-download"></i> Download Table JSON (${tableSizeKB} KB)`;
                    downloadTableBtn.style.display = 'inline-flex';
                }
            }

            function showTableSummary(data) {
                const tableSummarySection = document.getElementById('tableSummarySection');
                const tableSummaryDisplay = document.getElementById('tableSummaryDisplay');
                
                if (!tableSummarySection || !tableSummaryDisplay) {
                    console.error('Table summary elements not found');
                    return;
                }
                
                // Extract table data - check both locations
                let tableData = data.table_data || data;
                if (!tableData || !tableData.workbook || !tableData.workbook.sheets) {
                    console.log('No table data found for summary');
                    tableSummaryDisplay.innerHTML = '<div class="summary-no-tables">No table data available</div>';
                    tableSummarySection.style.display = 'block';
                    return;
                }
                
                let summaryHTML = '';
                const sheets = tableData.workbook.sheets;
                
                for (let i = 0; i < sheets.length; i++) {
                    const sheet = sheets[i];
                    const sheetName = sheet.name || `Sheet ${i + 1}`;
                    const tables = sheet.tables || [];
                    
                    summaryHTML += `<div class="summary-sheet">`;
                    summaryHTML += `<div class="summary-sheet-header">`;
                    summaryHTML += `<h3 class="summary-sheet-name"><i class="fas fa-file-alt"></i> ${sheetName}</h3>`;
                    summaryHTML += `<div class="summary-sheet-stats">${tables.length} table${tables.length !== 1 ? 's' : ''}</div>`;
                    summaryHTML += `</div>`;
                    
                    if (tables.length > 0) {
                        summaryHTML += `<div class="summary-tables">`;
                        
                        for (let j = 0; j < tables.length; j++) {
                            const table = tables[j];
                            const tableTitle = table.title || table.name || table.table_title || table.id || `Table ${j + 1}`;
                            
                            // Extract coordinates - check different possible locations
                            let upperLeft = 'N/A';
                            let lowerRight = 'N/A';
                            let tableSize = 'Unknown';
                            
                            // Method 1: Check for compact format region array [start_row, start_col, end_row, end_col]
                            if (table.region && Array.isArray(table.region) && table.region.length === 4) {
                                const [startRow, startCol, endRow, endCol] = table.region;
                                upperLeft = `${getColumnLetter(startCol)}${startRow}`;
                                lowerRight = `${getColumnLetter(endCol)}${endRow}`;
                                const rows = endRow - startRow + 1;
                                const cols = endCol - startCol + 1;
                                tableSize = `${rows}  ${cols}`;
                            }
                            
                            // Method 2: Check for region object coordinates
                            else if (table.region && typeof table.region === 'object' && !Array.isArray(table.region)) {
                                const region = table.region;
                                if (region.start_row && region.start_col && region.end_row && region.end_col) {
                                    upperLeft = `${getColumnLetter(region.start_col)}${region.start_row}`;
                                    lowerRight = `${getColumnLetter(region.end_col)}${region.end_row}`;
                                    const rows = region.end_row - region.start_row + 1;
                                    const cols = region.end_col - region.start_col + 1;
                                    tableSize = `${rows}  ${cols}`;
                                }
                            }
                            
                            // Method 3: Check for start/end coordinates directly on table
                            else if (table.start_row && table.start_col && table.end_row && table.end_col) {
                                upperLeft = `${getColumnLetter(table.start_col)}${table.start_row}`;
                                lowerRight = `${getColumnLetter(table.end_col)}${table.end_row}`;
                                const rows = table.end_row - table.start_row + 1;
                                const cols = table.end_col - table.start_col + 1;
                                tableSize = `${rows}  ${cols}`;
                            }
                            
                            // Method 4: Estimate from columns and rows
                            else if (table.columns && table.rows) {
                                const colCount = table.columns.length;
                                const rowCount = table.rows.length;
                                tableSize = `${rowCount}  ${colCount}`;
                                
                                // Try to extract first/last coordinates from columns
                                if (colCount > 0 && rowCount > 0) {
                                    const firstCol = table.columns[0];
                                    const lastCol = table.columns[colCount - 1];
                                    const firstRow = table.rows[0];
                                    const lastRow = table.rows[rowCount - 1];
                                    
                                    if (firstCol.column_index && firstRow.row_index) {
                                        upperLeft = `${getColumnLetter(firstCol.column_index)}${firstRow.row_index}`;
                                    }
                                    if (lastCol.column_index && lastRow.row_index) {
                                        lowerRight = `${getColumnLetter(lastCol.column_index)}${lastRow.row_index}`;
                                    }
                                }
                            }
                            
                            // Numeric cells from meta if present
                            let numericCells = 0;
                            if (table.meta && typeof table.meta.numeric_cells === 'number') {
                                numericCells = table.meta.numeric_cells;
                            }

                            // Debug: Log what we found for this table
                            console.log(`DEBUG: Table ${j + 1} in sheet ${sheetName}:`, {
                                hasRegion: !!table.region,
                                regionType: Array.isArray(table.region) ? 'array' : typeof table.region,
                                regionValue: table.region,
                                upperLeft: upperLeft,
                                lowerRight: lowerRight,
                                tableSize: tableSize,
                                numericCells
                            });
                            
                            summaryHTML += `<div class="summary-table">`;
                            summaryHTML += `<div class="summary-table-header">`;
                            
                            // Show title with indicator if it was detected vs generated
                            const titleIcon = table.title ? '<i class="fas fa-tag" title="Detected table title"></i>' : '<i class="fas fa-table"></i>';
                            const titleClass = table.title ? 'detected-title' : '';
                            summaryHTML += `<h4 class="summary-table-title ${titleClass}">${titleIcon} ${tableTitle}</h4>`;
                            
                            summaryHTML += `<div class="summary-table-size">${tableSize}</div>`;
                            summaryHTML += `</div>`;
                            
                            summaryHTML += `<div class="summary-table-coordinates">`;
                            summaryHTML += `<div class="summary-coordinate-group">`;
                            summaryHTML += `<span class="summary-coordinate-label">Upper Left:</span>`;
                            summaryHTML += `<span class="summary-coordinate-value">${upperLeft}</span>`;
                            summaryHTML += `</div>`;
                            summaryHTML += `<div class="summary-coordinate-group">`;
                            summaryHTML += `<span class="summary-coordinate-label">Lower Right:</span>`;
                            summaryHTML += `<span class="summary-coordinate-value">${lowerRight}</span>`;
                            summaryHTML += `</div>`;
                            if (upperLeft !== 'N/A' && lowerRight !== 'N/A') {
                                summaryHTML += `<div class="summary-coordinate-group">`;
                                summaryHTML += `<span class="summary-coordinate-label">Range:</span>`;
                                summaryHTML += `<span class="summary-coordinate-range">${upperLeft}:${lowerRight}</span>`;
                                summaryHTML += `</div>`;
                            }
                            // Numeric cells indicator
                            summaryHTML += `<div class="summary-coordinate-group">`;
                            summaryHTML += `<span class="summary-coordinate-label">Numeric Cells:</span>`;
                            summaryHTML += `<span class="summary-coordinate-value">${numericCells}</span>`;
                            summaryHTML += `</div>`;
                            summaryHTML += `</div>`;
                            summaryHTML += `</div>`;
                        }
                        
                        summaryHTML += `</div>`;
                    } else {
                        summaryHTML += `<div class="summary-no-tables">No tables detected in this sheet</div>`;
                    }
                    
                    summaryHTML += `</div>`;
                }
                
                tableSummaryDisplay.innerHTML = summaryHTML;
                tableSummarySection.style.display = 'block';
            }
            
            function getColumnLetter(col) {
                let result = '';
                while (col > 0) {
                    col--;
                    result = String.fromCharCode(65 + (col % 26)) + result;
                    col = Math.floor(col / 26);
                }
                return result;
            }

            function showCellDisplay(data) {
                updateCellDisplay(data);
                cellDisplaySection.style.display = 'block';
                
                // Ensure download button is visible
                const downloadCellDataBtn = document.getElementById('downloadCellDataBtn');
                if (downloadCellDataBtn) {
                    downloadCellDataBtn.style.display = 'inline-flex';
                }
            }

            // Large file handling functions
            function showLargeFileWarning(data) {
                // Clear any existing warnings first
                const existingWarning = document.querySelector('.large-file-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                const warningDiv = document.createElement('div');
                warningDiv.className = 'large-file-warning';
                warningDiv.innerHTML = `
                    <div class="warning-content">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Large File Detected</h3>
                        <p>${data.warning}</p>
                        <p>The file contains ${data.file_info.sheet_count} sheets with ${data.file_info.total_tables} tables.</p>
                    </div>
                `;
                
                // Insert warning at the top of the results section
                const resultsSection = document.querySelector('.result-section');
                if (resultsSection) {
                    resultsSection.insertBefore(warningDiv, resultsSection.firstChild);
                    resultsSection.style.display = 'block'; // Make sure it's visible
                } else {
                    // Fallback: append to body
                    document.body.insertBefore(warningDiv, document.body.firstChild);
                }
                
                // Add CSS for the warning
                const style = document.createElement('style');
                style.textContent = `
                    .large-file-warning {
                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                        color: white;
                        padding: 1.5rem;
                        border-radius: 10px;
                        margin-bottom: 2rem;
                        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
                    }
                    .warning-content {
                        text-align: center;
                    }
                    .warning-content i {
                        font-size: 2rem;
                        margin-bottom: 1rem;
                    }
                    .warning-content h3 {
                        margin: 0 0 1rem 0;
                        font-size: 1.5rem;
                    }
                    .warning-content p {
                        margin: 0.5rem 0;
                    }
                `;
                document.head.appendChild(style);
            }

            function showLargeFileInfo(file, data) {
                fullFileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                sheetCount.textContent = data.file_info.sheet_count;
                fileInfo.style.display = 'block';
            }

            function showLargeFileSummary(summary) {
                // Clear any existing summary first
                const existingSummary = document.querySelector('.large-file-summary');
                if (existingSummary) {
                    existingSummary.remove();
                }
                
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'large-file-summary';
                summaryDiv.innerHTML = `
                    <h3><i class="fas fa-chart-bar"></i> File Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="label">Sheets:</span>
                            <span class="value">${summary.workbook.sheets.length}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Total Tables:</span>
                            <span class="value">${summary.workbook.sheets.reduce((sum, sheet) => sum + sheet.table_count, 0)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Total Rows:</span>
                            <span class="value">${summary.workbook.sheets.reduce((sum, sheet) => sum + sheet.total_rows, 0)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Total Columns:</span>
                            <span class="value">${summary.workbook.sheets.reduce((sum, sheet) => sum + sheet.total_columns, 0)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Total Numeric Cells:</span>
                            <span class="value">${summary.workbook.total_numeric_cells ?? 0}</span>
                        </div>
                    </div>
                    <div class="sheet-list">
                        <h4>Sheets:</h4>
                        <ul>
                            ${summary.workbook.sheets.map(sheet => `
                                <li>${sheet.name} (${sheet.table_count} tables, ${sheet.total_rows} rows, ${sheet.total_columns} columns, ${sheet.numeric_cells ?? 0} numeric cells)</li>
                            `).join('')}
                        </ul>
                    </div>
                    
                `;
                
                // Insert summary after the warning
                const warning = document.querySelector('.large-file-warning');
                if (warning) {
                    warning.parentNode.insertBefore(summaryDiv, warning.nextSibling);
                } else {
                    // Fallback: append to the first result section
                    const resultsSection = document.querySelector('.result-section');
                    if (resultsSection) {
                        resultsSection.appendChild(summaryDiv);
                    } else {
                        document.body.appendChild(summaryDiv);
                    }
                }
                
                // Add CSS for the summary
                const style = document.createElement('style');
                style.textContent = `
                    .large-file-summary {
                        background: #f8f9fa;
                        border: 1px solid #dee2e6;
                        border-radius: 10px;
                        padding: 1.5rem;
                        margin-bottom: 2rem;
                    }
                    .large-file-summary h3 {
                        color: #495057;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    }
                    .summary-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 1rem;
                        margin-bottom: 1.5rem;
                    }
                    .summary-item {
                        background: white;
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #dee2e6;
                        text-align: center;
                    }
                    .summary-item .label {
                        display: block;
                        font-weight: 600;
                        color: #6c757d;
                        margin-bottom: 0.5rem;
                    }
                    .summary-item .value {
                        display: block;
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: #495057;
                    }
                    .sheet-list h4 {
                        color: #495057;
                        margin-bottom: 0.5rem;
                    }
                    .sheet-list ul {
                        list-style: none;
                        padding: 0;
                    }
                    .sheet-list li {
                        padding: 0.5rem;
                        background: white;
                        border: 1px solid #dee2e6;
                        border-radius: 4px;
                        margin-bottom: 0.25rem;
                        font-size: 0.9rem;
                    }
                    
                `;
                document.head.appendChild(style);
            }

            function showDownloadLinks(downloadUrls, fileInfo) {
                // Clear any existing download links
                const existingLinks = document.querySelector('.download-links');
                if (existingLinks) {
                    existingLinks.remove();
                }
                
                const linksDiv = document.createElement('div');
                linksDiv.className = 'download-links';
                linksDiv.innerHTML = `
                    <h3><i class="fas fa-download"></i> Download Options</h3>
                    <div class="download-grid">
                        <div class="download-item">
                            <h4>Full Data</h4>
                            <p>Complete Excel structure with all metadata</p>
                            <p><strong>Size:</strong> ${fileInfo.json_data_size_mb.toFixed(1)} MB</p>
                            <a href="${downloadUrls.full_data}" class="download-btn" download>
                                <i class="fas fa-download"></i> Download Full Data
                            </a>
                        </div>
                        <div class="download-item">
                            <h4>Table Data</h4>
                            <p>Table-oriented format with resolved headers</p>
                            <p><strong>Size:</strong> ${fileInfo.table_data_size_mb.toFixed(1)} MB</p>
                            <a href="${downloadUrls.table_data}" class="download-btn" download>
                                <i class="fas fa-download"></i> Download Table Data
                            </a>
                        </div>
                    </div>
                `;
                
                // Insert download links after the summary
                const summary = document.querySelector('.large-file-summary');
                if (summary) {
                    summary.parentNode.insertBefore(linksDiv, summary.nextSibling);
                } else {
                    // Fallback: append to the first result section
                    const resultsSection = document.querySelector('.result-section');
                    if (resultsSection) {
                        resultsSection.appendChild(linksDiv);
                    } else {
                        document.body.appendChild(linksDiv);
                    }
                }
                
                // Add CSS for the download links
                const style = document.createElement('style');
                style.textContent = `
                    .download-links {
                        background: #e3f2fd;
                        border: 1px solid #bbdefb;
                        border-radius: 10px;
                        padding: 1.5rem;
                        margin-bottom: 2rem;
                    }
                    .download-links h3 {
                        color: #1976d2;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    }
                    .download-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 1.5rem;
                    }
                    .download-item {
                        background: white;
                        padding: 1.5rem;
                        border-radius: 8px;
                        border: 1px solid #bbdefb;
                        text-align: center;
                    }
                    .download-item h4 {
                        color: #1976d2;
                        margin-bottom: 0.5rem;
                    }
                    .download-item p {
                        color: #666;
                        margin-bottom: 0.5rem;
                        font-size: 0.9rem;
                    }
                    .download-item .download-btn {
                        display: inline-flex;
                        align-items: center;
                        gap: 0.5rem;
                        background: #1976d2;
                        color: white;
                        padding: 0.75rem 1.5rem;
                        border-radius: 6px;
                        text-decoration: none;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        margin-top: 1rem;
                    }
                    .download-item .download-btn:hover {
                        background: #1565c0;
                        transform: translateY(-2px);
                        text-decoration: none;
                        color: white;
                    }
                `;
                document.head.appendChild(style);
            }

            // Sheet and table display functions
            function createSheetTabs(sheets) {
                sheetTabs.innerHTML = '';
                
                sheets.forEach((sheet, index) => {
                    const tab = document.createElement('button');
                    tab.className = `sheet-tab ${index === currentSheetIndex ? 'active' : ''}`;
                    tab.textContent = sheet.name || `Sheet ${index + 1}`;
                    tab.onclick = () => switchSheet(index);
                    sheetTabs.appendChild(tab);
                });
            }

            function switchSheet(sheetIndex) {
                currentSheetIndex = sheetIndex;
                
                // Update tab states
                const tabs = sheetTabs.querySelectorAll('.sheet-tab');
                tabs.forEach((tab, index) => {
                    tab.classList.toggle('active', index === sheetIndex);
                });
                
                // Show the selected sheet
                if (convertedDisplayData && convertedDisplayData.workbook.sheets[sheetIndex]) {
                    showSheet(convertedDisplayData.workbook.sheets[sheetIndex]);
                } else {
                    console.error('No converted display data available for sheet index:', sheetIndex);
                }
            }

            function showSheet(sheet) {
                const table = createDataTable(sheet);
                tableContainer.innerHTML = '';
                tableContainer.appendChild(table);
                
                // Debug: Check if table was added and is visible
                console.log('DEBUG: Table appended to container');
                console.log('DEBUG: tableContainer display style:', window.getComputedStyle(tableContainer).display);
                console.log('DEBUG: tableContainer visibility:', window.getComputedStyle(tableContainer).visibility);
                console.log('DEBUG: Table children count:', table.children.length);
                console.log('DEBUG: First table row HTML:', table.children[1] ? table.children[1].innerHTML.substring(0, 100) : 'No tbody');
            }

            function createDataTable(sheet) {
                console.log('createDataTable called for:', sheet.name);
                const table = document.createElement('table');
                table.className = 'data-table';
                
                // Find the data range
                const dataRange = findDataRange(sheet);
                console.log('createDataTable: dataRange result:', dataRange);
                if (!dataRange) {
                    console.log('createDataTable: No data range found, showing empty message');
                    table.innerHTML = '<tr><td colspan="1" style="text-align: center; padding: 2rem;">No data found in this sheet</td></tr>';
                    return table;
                }
                
                // Create header row
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                // Add row number column header
                const rowHeader = document.createElement('th');
                rowHeader.textContent = 'Row';
                rowHeader.style.backgroundColor = '#f1f3f4';
                rowHeader.style.fontWeight = 'bold';
                rowHeader.style.textAlign = 'center';
                rowHeader.style.minWidth = '50px';
                headerRow.appendChild(rowHeader);
                
                for (let col = dataRange.minCol; col <= dataRange.maxCol; col++) {
                    const th = document.createElement('th');
                    th.textContent = getColumnLabel(col);
                    headerRow.appendChild(th);
                }
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create data rows
                const tbody = document.createElement('tbody');
                for (let row = dataRange.minRow; row <= dataRange.maxRow; row++) {
                    const tr = document.createElement('tr');
                    
                    // Add row number column
                    const rowNumTd = document.createElement('td');
                    rowNumTd.textContent = row;
                    rowNumTd.style.backgroundColor = '#f8f9fa';
                    rowNumTd.style.fontWeight = 'bold';
                    rowNumTd.style.textAlign = 'center';
                    rowNumTd.style.borderRight = '2px solid #dee2e6';
                    tr.appendChild(rowNumTd);
                    
                    for (let col = dataRange.minCol; col <= dataRange.maxCol; col++) {
                        const td = document.createElement('td');
                        const cellData = getCellData(sheet, row, col);
                        const formattedContent = formatCellContent(cellData);
                        td.innerHTML = formattedContent;
                        
                        // Debug: Log cell content for first few rows
                        if (row <= 2 && col <= 3) {
                            console.log(`DEBUG: Cell (${row},${col}) - Value: "${cellData.value}", Formatted: "${formattedContent}"`);
                            console.log(`DEBUG: TD innerHTML set to: "${td.innerHTML}"`);
                            console.log(`DEBUG: TD element:`, td);
                        }
                        
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }
                table.appendChild(tbody);
                
                console.log('createDataTable: Table created with', tbody.children.length, 'rows');
                return table;
            }

            function findDataRange(sheet) {
                console.log('findDataRange called for sheet:', sheet.name);
                console.log('Sheet has cells:', !!sheet.cells);
                console.log('Sheet cells type:', typeof sheet.cells);
                console.log('Number of cells:', sheet.cells ? Object.keys(sheet.cells).length : 0);
                
                let minRow = Infinity, maxRow = -1, minCol = Infinity, maxCol = -1;
                let hasData = false;
                
                if (!sheet.cells) {
                    console.log('ERROR: Sheet has no cells property!');
                    return null;
                }
                
                // Find the range of cells with data
                for (const [cellRef, cell] of Object.entries(sheet.cells)) {
                    const [row, col] = parseCellRef(cellRef);
                    if (cell.value !== null && cell.value !== undefined && cell.value !== '') {
                        minRow = Math.min(minRow, row);
                        maxRow = Math.max(maxRow, row);
                        minCol = Math.min(minCol, col);
                        maxCol = Math.max(maxCol, col);
                        hasData = true;
                    }
                }
                
                const result = hasData ? { minRow, maxRow, minCol, maxCol } : null;
                console.log('findDataRange result:', result);
                if (result) {
                    console.log(`Data range: rows ${result.minRow}-${result.maxRow}, cols ${result.minCol}-${result.maxCol}`);
                }
                return result;
            }

            function parseCellRef(cellRef) {
                const match = cellRef.match(/^([A-Z]+)(\d+)$/);
                if (!match) return [0, 0];
                
                const colStr = match[1];
                const row = parseInt(match[2]);
                let col = 0;
                
                for (let i = 0; i < colStr.length; i++) {
                    col = col * 26 + (colStr.charCodeAt(i) - 64);
                }
                
                return [row, col];
            }

            function getColumnLabel(col) {
                let label = '';
                while (col > 0) {
                    col--;
                    label = String.fromCharCode(65 + (col % 26)) + label;
                    col = Math.floor(col / 26);
                }
                return label;
            }

            function getCellData(sheet, row, col) {
                const cellRef = getCellRef(row, col);
                const cellData = sheet.cells[cellRef] || { value: '', formula: null, comment: null, hyperlink: null };
                // Debug: Log cell data retrieval for a few cells
                if (row <= 3 && col <= 3) {
                    console.log(`DEBUG: getCellData(${row}, ${col}) -> cellRef: ${cellRef}, value:`, cellData.value);
                }
                return cellData;
            }

            function formatCellContent(cellData) {
                let content = '';
                let tooltip = '';
                
                // Main value with formatting
                if (cellData.value !== null && cellData.value !== undefined && cellData.value !== '') {
                    let formattedValue = cellData.value;
                    let cssClass = '';
                    
                    // Apply number formatting if available
                    if (cellData.style && cellData.style.number_format) {
                        formattedValue = formatNumberWithStyle(cellData.value, cellData.style.number_format);
                    }
                    
                    // Apply currency formatting
                    if (cellData.style && cellData.style.number_format && 
                        (cellData.style.number_format.includes('$') || 
                         cellData.style.number_format.includes('Currency'))) {
                        cssClass = 'cell-currency';
                    }
                    
                    // Apply negative number styling
                    if (typeof cellData.value === 'number' && cellData.value < 0) {
                        cssClass += ' cell-negative';
                    }
                    
                    // Add formula tooltip if present
                    if (cellData.formula) {
                        cssClass += ' cell-with-formula';
                        tooltip = `title="Formula: = ${cellData.formula}"`;
                    }
                    
                    if (cellData.hyperlink) {
                        const linkClass = cssClass ? `cell-hyperlink ${cssClass}` : 'cell-hyperlink';
                        content += `<a href="${cellData.hyperlink}" class="${linkClass}" ${tooltip} target="_blank">${formattedValue}</a>`;
                    } else {
                        const spanClass = cssClass ? ` class="${cssClass}"` : '';
                        content += `<span${spanClass} ${tooltip}>${formattedValue}</span>`;
                    }
                }
                
                // Comment
                if (cellData.comment) {
                    content += `<div class="cell-comment"> ${cellData.comment}</div>`;
                }
                
                return content || '&nbsp;';
            }

            function formatNumberWithStyle(value, numberFormat) {
                if (typeof value !== 'number') {
                    return value;
                }
                
                // Handle currency formats
                if (numberFormat.includes('$')) {
                    const isNegative = value < 0;
                    const absValue = Math.abs(value);
                    
                    // Determine decimal places from format
                    let decimalPlaces = 2; // default
                    if (numberFormat.includes('#,##0.00')) {
                        decimalPlaces = 2;
                    } else if (numberFormat.includes('#,##0.0')) {
                        decimalPlaces = 1;
                    } else if (numberFormat.includes('#,##0')) {
                        decimalPlaces = 0;
                    }
                    
                    const formatted = absValue.toFixed(decimalPlaces);
                    return `$${formatted}`;
                }
                
                // Handle percentage formats
                if (numberFormat.includes('%')) {
                    let decimalPlaces = 0;
                    if (numberFormat.includes('0.00%')) {
                        decimalPlaces = 2;
                    } else if (numberFormat.includes('0.0%')) {
                        decimalPlaces = 1;
                    }
                    return (value * 100).toFixed(decimalPlaces) + '%';
                }
                
                // Handle decimal formats
                if (numberFormat.includes('0.00')) {
                    return value.toFixed(2);
                } else if (numberFormat.includes('0.0')) {
                    return value.toFixed(1);
                } else if (numberFormat.includes('0')) {
                    return Math.round(value).toString();
                }
                
                // Default formatting
                return value.toString();
            }

            function updateJSONDisplay(data) {
                switch (currentDisplayType) {
                    case 'formatted':
                        jsonDisplay.innerHTML = formatJSON(data);
                        break;
                    case 'compact':
                        jsonDisplay.innerHTML = formatJSON(compactJSON(data));
                        break;
                    case 'raw':
                        jsonDisplay.textContent = JSON.stringify(data, null, 2);
                        break;
                }
            }

            function changeDisplayType() {
                currentDisplayType = displayType.value;
                if (jsonData) {
                    updateJSONDisplay(jsonData);
                }
            }

            function changeTableDisplayType() {
                currentTableDisplayType = tableDisplayType.value;
                if (tableData) {
                    updateTableJSONDisplay(tableData);
                }
            }

            function changeCellDisplayType() {
                currentCellDisplayType = cellDisplayType.value;
                if (tableData) {
                    updateCellDisplay(tableData);
                }
            }

            function updateTableJSONDisplay(data) {
                switch (currentTableDisplayType) {
                    case 'formatted':
                        tableJsonDisplay.innerHTML = formatJSON(data);
                        break;
                    case 'compact':
                        tableJsonDisplay.innerHTML = formatJSON(compactJSON(data));
                        break;
                    case 'raw':
                        tableJsonDisplay.textContent = JSON.stringify(data, null, 2);
                        break;
                }
            }

            function updateCellDisplay(data) {
                switch (currentCellDisplayType) {
                    case 'cards':
                        cellDisplay.innerHTML = createCellCards(data);
                        break;
                    case 'table':
                        cellDisplay.innerHTML = createCellTable(data);
                        break;
                    case 'compact':
                        cellDisplay.innerHTML = createCellList(data);
                        break;
                }
            }

            // Cell display functions
            function createCellCards(data) {
                let html = '';
                
                // Use table_data for cell cards if available, otherwise fall back to main data
                const dataSource = data.table_data || data;
                
                for (let i = 0; i < dataSource.workbook.sheets.length; i++) {
                    const sheet = dataSource.workbook.sheets[i];
                    const sheetName = sheet.name || `Sheet ${i + 1}`;
                    
                    html += `<div class="cell-sheet-section">`;
                    html += `<h3 style="margin-bottom: 1rem; color: #495057; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">${sheetName}</h3>`;
                    
                    console.log(`DEBUG: createCellCards - Sheet ${sheetName} has tables:`, !!sheet.tables, 'Count:', sheet.tables ? sheet.tables.length : 0);
                    
                    if (sheet.tables && sheet.tables.length > 0) {
                        html += `<div class="cell-cards">`;
                        
                        for (const table of sheet.tables) {
                            // Extract cells with headers from the table structure
                            const cellsWithHeaders = extractCellsWithHeaders(table);
                            for (const cell of cellsWithHeaders) {
                                html += createCellCard(cell);
                            }
                        }
                        
                        html += `</div>`;
                    } else {
                        html += `<p style="color: #6c757d; text-align: center; padding: 2rem;">No data cells with headers found in this sheet.</p>`;
                    }
                    
                    html += `</div>`;
                }
                
                return html;
            }

            function extractCellsWithHeaders(table) {
                const cellsWithHeaders = [];
                
                // Iterate through columns to find cells with headers
                if (table.columns) {
                    for (const column of table.columns) {
                        if (column.cells) {
                            for (const [coordinate, cell] of Object.entries(column.cells)) {
                                // Check if this cell has headers (indicating it's a data cell)
                                if (cell.headers && (cell.headers.column_headers || cell.headers.row_headers)) {
                                    const cellData = {
                                        coordinate: cell.coordinate,
                                        value: cell.value,
                                        column_headers: cell.headers.column_headers ? cell.headers.column_headers.map(h => h.value) : [],
                                        row_headers: cell.headers.row_headers ? cell.headers.row_headers.map(h => h.value) : []
                                    };
                                    cellsWithHeaders.push(cellData);
                                }
                            }
                        }
                    }
                }
                
                return cellsWithHeaders;
            }

            function createCellCard(cell) {
                const coordinate = cell.coordinate || 'Unknown';
                const value = cell.value !== null && cell.value !== undefined ? cell.value : 'N/A';
                const columnHeaders = cell.column_headers || [];
                const rowHeaders = cell.row_headers || [];
                
                let html = `<div class="cell-card">`;
                html += `<div class="cell-card-header">`;
                html += `<span class="cell-coordinate">${coordinate}</span>`;
                html += `</div>`;
                
                html += `<div class="cell-value">${value}</div>`;
                
                html += `<div class="cell-headers">`;
                
                if (columnHeaders.length > 0) {
                    html += `<div class="header-group">`;
                    html += `<span class="header-label">Columns:</span>`;
                    html += `<div class="header-values">`;
                    columnHeaders.forEach(header => {
                        html += `<span class="header-tag column">${header}</span>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
                
                if (rowHeaders.length > 0) {
                    html += `<div class="header-group">`;
                    html += `<span class="header-label">Rows:</span>`;
                    html += `<div class="header-values">`;
                    rowHeaders.forEach(header => {
                        html += `<span class="header-tag row">${header}</span>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
                html += `</div>`;
                
                return html;
            }

            function createCellTable(data) {
                let html = '';
                
                // Use table_data for cell table if available, otherwise fall back to main data
                const dataSource = data.table_data || data;
                
                for (let i = 0; i < dataSource.workbook.sheets.length; i++) {
                    const sheet = dataSource.workbook.sheets[i];
                    const sheetName = sheet.name || `Sheet ${i + 1}`;
                    
                    html += `<div class="cell-sheet-section">`;
                    html += `<h3 style="margin-bottom: 1rem; color: #495057; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">${sheetName}</h3>`;
                    
                    console.log(`DEBUG: createCellTable - Sheet ${sheetName} has tables:`, !!sheet.tables, 'Count:', sheet.tables ? sheet.tables.length : 0);
                    
                    if (sheet.tables && sheet.tables.length > 0) {
                        html += `<table class="cell-table">`;
                        html += `<thead>`;
                        html += `<tr>`;
                        html += `<th>Coordinate</th>`;
                        html += `<th>Value</th>`;
                        html += `<th>Column Headers</th>`;
                        html += `<th>Row Headers</th>`;
                        html += `</tr>`;
                        html += `</thead>`;
                        html += `<tbody>`;
                        
                        for (const table of sheet.tables) {
                            // Extract cells with headers from the table structure
                            const cellsWithHeaders = extractCellsWithHeaders(table);
                            for (const cell of cellsWithHeaders) {
                                html += createCellTableRow(cell);
                            }
                        }
                        
                        html += `</tbody>`;
                        html += `</table>`;
                    } else {
                        html += `<p style="color: #6c757d; text-align: center; padding: 2rem;">No data cells with headers found in this sheet.</p>`;
                    }
                    
                    html += `</div>`;
                }
                
                return html;
            }

            function createCellTableRow(cell) {
                const coordinate = cell.coordinate || 'Unknown';
                const value = cell.value !== null && cell.value !== undefined ? cell.value : 'N/A';
                const columnHeaders = cell.column_headers || [];
                const rowHeaders = cell.row_headers || [];
                
                let html = `<tr>`;
                html += `<td><span class="cell-coordinate">${coordinate}</span></td>`;
                html += `<td><strong>${value}</strong></td>`;
                html += `<td>`;
                columnHeaders.forEach(header => {
                    html += `<span class="header-tag column">${header}</span> `;
                });
                html += `</td>`;
                html += `<td>`;
                rowHeaders.forEach(header => {
                    html += `<span class="header-tag row">${header}</span> `;
                });
                html += `</td>`;
                html += `</tr>`;
                
                return html;
            }

            function createCellList(data) {
                let html = '';
                
                // Use table_data for cell list if available, otherwise fall back to main data
                const dataSource = data.table_data || data;
                
                for (let i = 0; i < dataSource.workbook.sheets.length; i++) {
                    const sheet = dataSource.workbook.sheets[i];
                    const sheetName = sheet.name || `Sheet ${i + 1}`;
                    
                    html += `<div class="cell-sheet-section">`;
                    html += `<h3 style="margin-bottom: 1rem; color: #495057; border-bottom: 2px solid #667eea; padding-bottom: 0.5rem;">${sheetName}</h3>`;
                    
                    console.log(`DEBUG: createCellList - Sheet ${sheetName} has tables:`, !!sheet.tables, 'Count:', sheet.tables ? sheet.tables.length : 0);
                    
                    if (sheet.tables && sheet.tables.length > 0) {
                        html += `<div class="cell-list">`;
                        
                        for (const table of sheet.tables) {
                            // Extract cells with headers from the table structure
                            const cellsWithHeaders = extractCellsWithHeaders(table);
                            for (const cell of cellsWithHeaders) {
                                html += createCellListItem(cell);
                            }
                        }
                        
                        html += `</div>`;
                    } else {
                        html += `<p style="color: #6c757d; text-align: center; padding: 2rem;">No data cells with headers found in this sheet.</p>`;
                    }
                    
                    html += `</div>`;
                }
                
                return html;
            }

            function createCellListItem(cell) {
                const coordinate = cell.coordinate || 'Unknown';
                const value = cell.value !== null && cell.value !== undefined ? cell.value : 'N/A';
                const columnHeaders = cell.column_headers || [];
                const rowHeaders = cell.row_headers || [];
                
                let html = `<div class="cell-list-item">`;
                html += `<span class="cell-list-coordinate">${coordinate}</span>`;
                html += `<span class="cell-list-value">${value}</span>`;
                html += `<div class="cell-list-headers">`;
                
                if (columnHeaders.length > 0) {
                    html += `<div class="cell-list-header-group">`;
                    html += `<span class="cell-list-header-label">Col:</span>`;
                    html += `<div class="cell-list-header-tags">`;
                    columnHeaders.forEach(header => {
                        html += `<span class="cell-list-header-tag column">${header}</span>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
                
                if (rowHeaders.length > 0) {
                    html += `<div class="cell-list-header-group">`;
                    html += `<span class="cell-list-header-label">Row:</span>`;
                    html += `<div class="cell-list-header-tags">`;
                    rowHeaders.forEach(header => {
                        html += `<span class="cell-list-header-tag row">${header}</span>`;
                    });
                    html += `</div>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
                html += `</div>`;
                
                return html;
            }

            // JSON formatting functions
            function compactJSON(obj) {
                if (obj === null || obj === false) {
                    return undefined;
                }
                
                if (typeof obj === 'boolean') {
                    return obj ? obj : undefined;
                }
                
                if (typeof obj === 'string') {
                    return obj === '' ? undefined : obj;
                }
                
                if (typeof obj === 'number') {
                    return obj;
                }
                
                if (Array.isArray(obj)) {
                    const compacted = obj.map(item => compactJSON(item)).filter(item => item !== undefined);
                    return compacted.length > 0 ? compacted : undefined;
                }
                
                if (typeof obj === 'object') {
                    const compacted = {};
                    for (const [key, value] of Object.entries(obj)) {
                        const compactedValue = compactJSON(value);
                        if (compactedValue !== undefined) {
                            compacted[key] = compactedValue;
                        }
                    }
                    return Object.keys(compacted).length > 0 ? compacted : undefined;
                }
                
                return obj;
            }

            function formatJSON(obj, indent = 0) {
                const spaces = '  '.repeat(indent);
                let result = '';
                
                if (obj === null) {
                    return '<span class="json-null">null</span>';
                }
                
                if (typeof obj === 'boolean') {
                    return `<span class="json-boolean">${obj}</span>`;
                }
                
                if (typeof obj === 'number') {
                    return `<span class="json-number">${obj}</span>`;
                }
                
                if (typeof obj === 'string') {
                    return `<span class="json-string">"${obj.replace(/"/g, '\\"')}"</span>`;
                }
                
                if (Array.isArray(obj)) {
                    if (obj.length === 0) {
                        return '<span class="json-bracket">[]</span>';
                    }
                    
                    result = '<span class="json-bracket">[</span>\n';
                    for (let i = 0; i < obj.length; i++) {
                        result += spaces + '  ' + formatJSON(obj[i], indent + 1);
                        if (i < obj.length - 1) {
                            result += '<span class="json-comma">,</span>';
                        }
                        result += '\n';
                    }
                    result += spaces + '<span class="json-bracket">]</span>';
                    return result;
                }
                
                if (typeof obj === 'object') {
                    const keys = Object.keys(obj);
                    if (keys.length === 0) {
                        return '<span class="json-bracket">{}</span>';
                    }
                    
                    result = '<span class="json-bracket">{</span>\n';
                    for (let i = 0; i < keys.length; i++) {
                        const key = keys[i];
                        result += spaces + '  <span class="json-key">"' + key + '"</span><span class="json-colon">:</span> ' + formatJSON(obj[key], indent + 1);
                        if (i < keys.length - 1) {
                            result += '<span class="json-comma">,</span>';
                        }
                        result += '\n';
                    }
                    result += spaces + '<span class="json-bracket">}</span>';
                    return result;
                }
                
                return String(obj);
            }

            // Download functions
            function downloadJSON() {
                if (!jsonData) {
                    alert('No JSON data available to download');
                    return;
                }
                
                const dataStr = JSON.stringify(jsonData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = currentFile ? `${currentFile.name.replace(/\.[^/.]+$/, '')}_data.json` : 'excel_data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function downloadTableJSON() {
                if (!tableData) {
                    alert('No table data available to download');
                    return;
                }
                
                const dataStr = JSON.stringify(tableData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = currentFile ? `${currentFile.name.replace(/\.[^/.]+$/, '')}_table_data.json` : 'excel_table_data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function downloadCellData() {
                if (!jsonData) {
                    alert('No cell data available to download');
                    return;
                }
                
                // Extract cell data from the JSON
                const cellData = {
                    workbook: {
                        sheets: jsonData.workbook.sheets.map(sheet => ({
                            name: sheet.name,
                            cells: sheet.cells
                        }))
                    }
                };
                
                const dataStr = JSON.stringify(cellData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = currentFile ? `${currentFile.name.replace(/\.[^/.]+$/, '')}_cell_data.json` : 'excel_cell_data.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // Utility functions
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function removeFile() {
                currentFile = null;
                jsonData = null;
                tableData = null;
                
                // Hide all panels
                fileInfo.style.display = 'none';
                tableDisplay.style.display = 'none';
                fileMetadata.style.display = 'none';
                resultSection.style.display = 'none';
                tableSummarySection.style.display = 'none';
                tableResultSection.style.display = 'none';
                cellDisplaySection.style.display = 'none';
                
                // Clear file input
                fileInput.value = '';
                
                // Hide error and success messages
                hideError();
                hideSuccess();
            }

            // Make functions globally accessible
            window.changeDisplayType = changeDisplayType;
            window.changeTableDisplayType = changeTableDisplayType;
            window.changeCellDisplayType = changeCellDisplayType;
            window.downloadJSON = downloadJSON;
            window.downloadTableJSON = downloadTableJSON;
            window.downloadCellData = downloadCellData;
            window.removeFile = removeFile;
        }
    </script>
</body>
</html> 